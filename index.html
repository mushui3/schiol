<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini-itch.io | æ¥µç°¡éŠæˆ²å¹³å°</title>
    <link rel="icon" href="data:,">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #1a1a1a; --card: #2d2d2d; --accent: #3ecf8e; --text: #eeeeee; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
               display: flex; height: 100vh; margin: 0; background: var(--bg); color: var(--text); }
        
        /* å´é‚Šæ¬„ */
        #sidebar { width: 320px; border-right: 1px solid #444; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .upload-panel { background: var(--card); padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #444; }
        
        /* éŠæˆ²åˆ—è¡¨ */
        .game-item { background: var(--card); padding: 12px; margin-bottom: 10px; cursor: pointer; border-radius: 6px; border: 1px solid transparent; transition: 0.2s; }
        .game-item:hover { border-color: var(--accent); background: #333; }
        .game-item h4 { margin: 0 0 5px 0; color: var(--accent); }
        .game-item p { margin: 0; font-size: 0.85em; color: #aaa; }

        /* ä¸»é¡¯ç¤ºå€ */
        #main-content { flex-grow: 1; display: flex; flex-direction: column; position: relative; }
        #player-header { padding: 15px; background: #222; border-bottom: 1px solid #444; font-weight: bold; }
        iframe { width: 100%; flex-grow: 1; border: none; background: white; }

        /* è¡¨å–®å…ƒç´  */
        input, textarea { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #444; background: #111; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 10px; background: var(--accent); border: none; color: #111; font-weight: bold; border-radius: 4px; cursor: pointer; }
        button:hover { opacity: 0.9; }
        .logout-btn { background: #ff4d4d; color: white; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>ğŸ® éŠæˆ²å¤§å»³</h2>
        <div id="game-list">è¼‰å…¥ä¸­...</div>

        <div id="auth-area" class="upload-panel">
            <h3>é–‹ç™¼è€…ç™»éŒ„</h3>
            <input type="email" id="email" placeholder="é›»å­ä¿¡ç®±">
            <input type="password" id="pass" placeholder="å¯†ç¢¼">
            <button onclick="handleLogin()">ç™»éŒ„</button>
            <p style="font-size: 12px; text-align: center;">(åˆæ¬¡ä½¿ç”¨è«‹ç›´æ¥ç™»éŒ„ï¼Œå¤±æ•—å‰‡æŒ‰è¨»å†Š)</p>
            <button style="background: #555; color: white;" onclick="handleSignUp()">è¨»å†Šå¸³è™Ÿ</button>
        </div>

        <div id="upload-area" class="upload-panel" style="display:none">
            <h3>ç™¼å¸ƒæ–°éŠæˆ²</h3>
            <input type="text" id="title" placeholder="éŠæˆ²åç¨±">
            <textarea id="desc" placeholder="ç°¡å–®ä»‹ç´¹éŠæˆ²..."></textarea>
            <label style="font-size: 12px;">é¸æ“‡éŠæˆ² HTML æª”æ¡ˆï¼š</label>
            <input type="file" id="game-file" accept=".html">
            <button onclick="publishGame()" id="upload-btn">ç™¼å¸ƒéŠæˆ²</button>
            <button class="logout-btn" onclick="handleLogout()">ç™»å‡ºå¸³è™Ÿ</button>
        </div>
    </div>

    <div id="main-content">
        <div id="player-header">è«‹å¾å·¦å´æŒ‘é¸éŠæˆ²</div>
        <iframe id="game-player" src="about:blank"></iframe>
    </div>

    <script>
        // --- 1. é…ç½®å€åŸŸ (è«‹å¡«å¯«ä½ çš„è³‡è¨Š) ---
        const SUPABASE_URL = 'https://xqlwpountntgjyloatmp.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_UnvxxxxebS_EezifbnbCtA_2dm5gkCN';

        // --- 2. åˆå§‹åŒ– Supabase å®¢æˆ¶ç«¯ ---
        const { createClient } = window.supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // ä»‹é¢å…ƒç´ 
        const authArea = document.getElementById('auth-area');
        const uploadArea = document.getElementById('upload-area');
        const gameList = document.getElementById('game-list');
        const playerHeader = document.getElementById('player-header');
        const gamePlayer = document.getElementById('game-player');

        // --- 3. ç›£è½ç™»éŒ„ç‹€æ…‹ ---
        _supabase.auth.onAuthStateChanged((event, session) => {
            console.log("Auth Event:", event);
            if (session) {
                authArea.style.display = 'none';
                uploadArea.style.display = 'block';
                playerHeader.innerText = `æ­¡è¿å›ä¾†ï¼Œ${session.user.email}`;
            } else {
                authArea.style.display = 'block';
                uploadArea.style.display = 'none';
                playerHeader.innerText = "è«‹å¾å·¦å´æŒ‘é¸éŠæˆ²";
            }
            loadGames(); // ç„¡è«–æ˜¯å¦ç™»éŒ„éƒ½è¼‰å…¥åˆ—è¡¨
        });

        // --- 4. ç™»éŒ„/è¨»å†Š/ç™»å‡ºé‚è¼¯ ---
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('pass').value;
            const { error } = await _supabase.auth.signInWithPassword({ email, password });
            if (error) alert("ç™»éŒ„å¤±æ•—: " + error.message);
        }

        async function handleSignUp() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('pass').value;
            const { error } = await _supabase.auth.signUp({ email, password });
            if (error) alert("è¨»å†Šè¨Šæ¯: " + error.message + " (è‹¥æ˜¯æ–°ç”¨æˆ¶è«‹æª¢æŸ¥ä¿¡ç®±é©—è­‰)");
            else alert("è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥ä¿¡ç®±é©—è­‰éƒµä»¶ã€‚");
        }

        async function handleLogout() {
            await _supabase.auth.signOut();
            location.reload();
        }

        // --- 5. è¼‰å…¥éŠæˆ²åˆ—è¡¨ ---
        async function loadGames() {
            const { data, error } = await _supabase
                .from('games')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                gameList.innerHTML = "è¼‰å…¥å¤±æ•—";
                return;
            }

            if (data.length === 0) {
                gameList.innerHTML = "ç›®å‰é‚„æ²’æœ‰éŠæˆ²ã€‚";
                return;
            }

            gameList.innerHTML = data.map(g => `
                <div class="game-item" onclick="playGame('${g.game_url}', '${g.title}')">
                    <h4>${g.title}</h4>
                    <p>${g.description || 'ç„¡æè¿°'}</p>
                </div>
            `).join('');
        }

        // --- 6. éŠç©éŠæˆ² ---
        function playGame(url, title) {
            gamePlayer.src = url;
            playerHeader.innerText = "æ­£åœ¨éŠç©ï¼š" + title;
        }

        // --- 7. ç™¼å¸ƒéŠæˆ²é‚è¼¯ ---
        async function publishGame() {
            const file = document.getElementById('game-file').files[0];
            const title = document.getElementById('title').value;
            const desc = document.getElementById('desc').value;
            const btn = document.getElementById('upload-btn');

            if (!file || !title) return alert("è«‹å¡«å¯«éŠæˆ²åç¨±ä¸¦é¸æ“‡ HTML æª”æ¡ˆ");

            btn.disabled = true;
            btn.innerText = "æ­£åœ¨ä¸Šå‚³æª”æ¡ˆ...";

            try {
                // A. ä¸Šå‚³åˆ° Storage (å­˜æ”¾åœ¨ game-files æ¡¶å…§)
                const fileExt = file.name.split('.').pop();
                const fileName = `${Math.random()}.${fileExt}`;
                const filePath = `user_uploads/${fileName}`;

                const { data: uploadData, error: uploadErr } = await _supabase.storage
                    .from('game-files')
                    .upload(filePath, file);

                if (uploadErr) throw uploadErr;

                // B. å–å¾—å…¬é–‹é€£çµ
                const { data: { publicUrl } } = _supabase.storage
                    .from('game-files')
                    .getPublicUrl(filePath);

                // C. å¯«å…¥è³‡æ–™åº«è¨˜éŒ„
                const { error: dbErr } = await _supabase.from('games').insert([
                    { 
                        title: title, 
                        description: desc, 
                        game_url: publicUrl,
                        developer_id: (await _supabase.auth.getUser()).data.user.id
                    }
                ]);

                if (dbErr) throw dbErr;

                alert("ç™¼å¸ƒæˆåŠŸï¼");
                location.reload();

            } catch (err) {
                alert("ç™¼ç”ŸéŒ¯èª¤: " + err.message);
                btn.disabled = false;
                btn.innerText = "ç™¼å¸ƒéŠæˆ²";
            }
        }
    </script>
</body>
</html>
