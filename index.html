<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æˆ‘çš„æ¥µç°¡éŠæˆ²å¹³å°</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; display: flex; height: 100vh; margin: 0; background: #111; color: white; }
        #sidebar { width: 300px; border-right: 1px solid #333; padding: 20px; overflow-y: auto; }
        #main-content { flex-grow: 1; display: flex; flex-direction: column; }
        iframe { width: 100%; flex-grow: 1; border: none; background: white; }
        .game-item { padding: 10px; border: 1px solid #444; margin-bottom: 10px; cursor: pointer; border-radius: 5px; }
        .game-item:hover { background: #222; }
        .upload-panel { background: #222; padding: 15px; margin-top: 20px; border-radius: 5px; }
        input, textarea { width: 100%; margin-bottom: 10px; background: #333; color: white; border: 1px solid #555; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>ğŸ® éŠæˆ²åˆ—è¡¨</h2>
        <div id="game-list">è¼‰å…¥ä¸­...</div>

        <div id="auth-area" class="upload-panel">
            <h3>é–‹ç™¼è€…ç™»éŒ„</h3>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="pass" placeholder="Password">
            <button onclick="login()">ç™»éŒ„</button>
        </div>

        <div id="upload-area" class="upload-panel" style="display:none">
            <h3>ç™¼å¸ƒæ–°éŠæˆ²</h3>
            <input type="text" id="title" placeholder="éŠæˆ²åç¨±">
            <textarea id="desc" placeholder="éŠæˆ²ä»‹ç´¹"></textarea>
            <label>é¸æ“‡éŠæˆ² HTML æ–‡ä»¶ï¼š</label>
            <input type="file" id="game-file" accept=".html">
            <button onclick="publishGame()" id="upload-btn">ç™¼å¸ƒåˆ°å¹³å°</button>
        </div>
    </div>

    <div id="main-content">
        <div id="player-header" style="padding:10px; background:#222;">
            è«‹é¸æ“‡ä¸€å€‹éŠæˆ²é–‹å§‹éŠç©
        </div>
        <iframe id="game-player" src="about:blank"></iframe>
    </div>

    <script>
        const _supabase = supabase.createClient('https://xqlwpountntgjyloatmp.supabase.co', 'sb_publishable_UnvxxxxebS_EezifbnbCtA_2dm5gkCN');

        // 1. ç›£è½ç™»éŒ„ç‹€æ…‹
        _supabase.auth.onAuthStateChanged((event, session) => {
            console.log("Auth Event:", event); // æ¸¬è©¦ç”¨ï¼Œå¯ä»¥åœ¨ Console çœ‹åˆ°ç‹€æ…‹
            if (session) {
                document.getElementById('auth-area').style.display = 'none';
                document.getElementById('upload-area').style.display = 'block';
                loadGames();
            } else {
                document.getElementById('auth-area').style.display = 'block';
                document.getElementById('upload-area').style.display = 'none';
            }
        });

        // 2. è¼‰å…¥æ‰€æœ‰éŠæˆ²
        async function loadGames() {
            const { data } = await _supabase.from('games').select('*').order('created_at', {ascending: false});
            const list = document.getElementById('game-list');
            list.innerHTML = data.map(g => `
                <div class="game-item" onclick="playGame('${g.game_url}', '${g.title}')">
                    <strong>${g.title}</strong><br><small>${g.description}</small>
                </div>
            `).join('');
        }

        // 3. éŠç©éŠæˆ²
        function playGame(url, title) {
            document.getElementById('game-player').src = url;
            document.getElementById('player-header').innerText = "æ­£åœ¨éŠç©ï¼š" + title;
        }

        // 4. ç™¼å¸ƒéŠæˆ² (ä¸Šå‚³æª”æ¡ˆ + å¯«å…¥è³‡æ–™åº«)
        async function publishGame() {
            const file = document.getElementById('game-file').files[0];
            const title = document.getElementById('title').value;
            const desc = document.getElementById('desc').value;
            if(!file || !title) return alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');

            const btn = document.getElementById('upload-btn');
            btn.innerText = "ä¸Šå‚³ä¸­...";
            
            // A. ä¸Šå‚³åˆ° Storage
            const fileName = `${Date.now()}_${file.name}`;
            const { data: uploadData, error: uploadErr } = await _supabase.storage
                .from('game-files')
                .upload(fileName, file);

            if(uploadErr) return alert(uploadErr.message);

            // B. ç²å–å…¬é–‹ç¶²å€
            const { data: { publicUrl } } = _supabase.storage.from('game-files').getPublicUrl(fileName);

            // C. å¯«å…¥è³‡æ–™åº«
            const { error: dbErr } = await _supabase.from('games').insert([
                { title: title, description: desc, game_url: publicUrl, developer_id: (await _supabase.auth.getUser()).data.user.id }
            ]);

            if(dbErr) alert(dbErr.message);
            else {
                alert('ç™¼å¸ƒæˆåŠŸï¼');
                location.reload();
            }
        }

        async function login() {
            const { error } = await _supabase.auth.signInWithPassword({
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            });
            if(error) alert(error.message);
        }
    </script>
</body>
</html>
